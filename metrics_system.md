# Система метрик для автоматического мониторинга азербайджанских СМИ

**Версия:** 1.0  
**Дата:** 17 декабря 2025 г.  
**Проект:** Media Monitoring System

## 1. Обзор системы метрик

Данная система метрик разработана для комплексной оценки качества и эффективности системы автоматического мониторинга азербайджанских СМИ. Метрики организованы по ключевым компонентам пайплайна обработки данных.

### 1.1. Архитектура системы

```
Источники -> Парсер -> БД -> Предобработка -> NER -> Дедупликация -> 
-> Извлечение связей -> Классификация рисков -> API -> Вывод
```

## 2. Метрики сбора данных (Data Collection Metrics)

### 2.1. Метрики парсера

**DCM-1: Покрытие источников (Source Coverage)**
- **Формула:** `CS = (источников_активных / источников_целевых) * 100%`
- **Целевое значение:** >= 100% (1-2 сайта по ТЗ)
- **Критическое значение:** < 50%
- **Описание:** Процент успешно подключенных источников

**DCM-2: Успешность парсинга (Parse Success Rate)**
- **Формула:** `PSR = (статей_успешно_спаршено / статей_попыток_парсинга) * 100%`
- **Целевое значение:** >= 85%
- **Критическое значение:** < 60%
- **Описание:** Доля успешно извлеченных статей без ошибок

**DCM-3: Объем базы данных (Database Volume)**
- **Формула:** `DV = количество_уникальных_статей`
- **Целевое значение:** >= 200 статей (по ТЗ)
- **Критическое значение:** < 150 статей
- **Описание:** Общее количество собранных статей

**DCM-4: Актуальность данных (Data Freshness)**
- **Формула:** `DF = медиана(текущая_дата - дата_публикации_статьи)`
- **Целевое значение:** <= 30 дней
- **Критическое значение:** > 180 дней
- **Описание:** Возраст данных в базе

**DCM-5: Скорость парсинга (Parsing Throughput)**
- **Формула:** `PT = статей_обработано / время_выполнения_сек`
- **Целевое значение:** >= 5 статей/сек
- **Критическое значение:** < 1 статья/сек
- **Описание:** Производительность парсера

## 3. Метрики извлечения сущностей (NER Metrics)

### 3.1. Базовые метрики качества NER

**NER-1: Точность извлечения имен (Precision for Persons)**
- **Формула:** `P_PER = TP_persons / (TP_persons + FP_persons)`
- **Целевое значение:** >= 60% (по ТЗ)
- **Критическое значение:** < 40%
- **Описание:** Доля правильно извлеченных персон среди всех извлеченных

**NER-2: Полнота извлечения имен (Recall for Persons)**
- **Формула:** `R_PER = TP_persons / (TP_persons + FN_persons)`
- **Целевое значение:** >= 55%
- **Критическое значение:** < 35%
- **Описание:** Доля найденных персон от всех присутствующих

**NER-3: F1-мера для персон (F1-Score for Persons)**
- **Формула:** `F1_PER = 2 * (P_PER * R_PER) / (P_PER + R_PER)`
- **Целевое значение:** >= 57%
- **Критическое значение:** < 37%
- **Описание:** Гармоническое среднее точности и полноты

**NER-4: Точность для организаций (Precision for Organizations)**
- **Формула:** `P_ORG = TP_orgs / (TP_orgs + FP_orgs)`
- **Целевое значение:** >= 65%
- **Критическое значение:** < 45%
- **Описание:** Точность извлечения названий компаний

**NER-5: Полнота для организаций (Recall for Organizations)**
- **Формула:** `R_ORG = TP_orgs / (TP_orgs + FN_orgs)`
- **Целевое значение:** >= 60%
- **Критическое значение:** < 40%
- **Описание:** Полнота извлечения организаций

**NER-6: F1-мера для организаций (F1-Score for Organizations)**
- **Формула:** `F1_ORG = 2 * (P_ORG * R_ORG) / (P_ORG + R_ORG)`
- **Целевое значение:** >= 62%
- **Критическое значение:** < 42%

**NER-7: Макро-усредненный F1 (Macro-averaged F1)**
- **Формула:** `F1_macro = среднее(F1_PER, F1_ORG, F1_LOC, F1_POS, ...)`
- **Целевое значение:** >= 60%
- **Критическое значение:** < 40%
- **Описание:** Усредненное качество по всем типам сущностей

### 3.2. Метрики ensemble модели

**NER-8: Согласованность моделей (Model Agreement)**
- **Формула:** `MA = сущностей_найденных_обеими_моделями / всех_уникальных_сущностей`
- **Целевое значение:** 40-70% (оптимальная зона)
- **Критическое значение:** < 20% или > 90%
- **Описание:** Степень согласия между Davlan и LocalDoc моделями

**NER-9: Покрытие типов сущностей (Entity Type Coverage)**
- **Формула:** `ETC = типов_сущностей_извлечено / типов_сущностей_целевых`
- **Целевые типы:** person, organization, location, position, date, event
- **Целевое значение:** 100% (все 6 типов)
- **Критическое значение:** < 66% (менее 4 типов)

**NER-10: Средняя уверенность модели (Average Confidence Score)**
- **Формула:** `ACS = среднее(confidence_всех_сущностей)`
- **Целевое значение:** >= 0.75
- **Критическое значение:** < 0.50
- **Описание:** Средняя уверенность модели в извлеченных сущностях

## 4. Метрики дедупликации (Deduplication Metrics)

**DED-1: Коэффициент сжатия (Compression Ratio)**
- **Формула:** `CR = 1 - (сущностей_после_дедупликации / сущностей_до_дедупликации)`
- **Целевое значение:** 20-40%
- **Критическое значение:** < 5% или > 70%
- **Описание:** Процент удаленных дубликатов

**DED-2: Качество нормализации имен (Name Normalization Quality)**
- **Оценка:** Экспертная проверка выборки из 50 имен
- **Целевое значение:** >= 80% правильных нормализаций
- **Описание:** Доля корректно объединенных вариантов написания

**DED-3: Сохранение уникальных сущностей (Unique Entity Preservation)**
- **Формула:** `UEP = истинно_уникальных_сохранено / всех_истинно_уникальных`
- **Целевое значение:** >= 95%
- **Критическое значение:** < 85%
- **Описание:** Доля правильно сохраненных уникальных сущностей

## 5. Метрики извлечения связей (Relationship Extraction Metrics)

### 5.1. Качество извлечения связей

**REL-1: Точность связей (Relationship Precision)**
- **Формула:** `P_REL = правильных_связей / всех_извлеченных_связей`
- **Целевое значение:** >= 70%
- **Критическое значение:** < 50%
- **Описание:** Доля корректно идентифицированных связей

**REL-2: Полнота связей (Relationship Recall)**
- **Формула:** `R_REL = найденных_связей / всех_реальных_связей`
- **Целевое значение:** >= 55%
- **Критическое значение:** < 35%
- **Описание:** Доля обнаруженных связей от всех существующих

**REL-3: F1-мера для связей (Relationship F1-Score)**
- **Формула:** `F1_REL = 2 * (P_REL * R_REL) / (P_REL + R_REL)`
- **Целевое значение:** >= 60%
- **Критическое значение:** < 40%

### 5.2. Метрики гибридного подхода

**REL-4: Покрытие методов (Method Coverage)**
- **Формула:** `MC = связей_с_подтверждением_>=2_методами / всех_связей`
- **Целевое значение:** >= 30%
- **Описание:** Доля связей, найденных несколькими методами (Regex, spaCy, BERT)

**REL-5: Распределение типов связей (Relation Type Distribution)**
- **Типы:** works_for, owns, manages, located_in, participated_in, etc.
- **Целевое значение:** >= 5 типов связей
- **Описание:** Разнообразие извлекаемых типов отношений

**REL-6: Глубина графа знаний (Knowledge Graph Depth)**
- **Формула:** `KGD = среднее_количество_связей_на_сущность`
- **Целевое значение:** >= 1.5 связей/сущность
- **Критическое значение:** < 0.5
- **Описание:** Связность графа знаний

## 6. Метрики классификации рисков (Risk Classification Metrics)

### 6.1. Качество детекции рисков

**RISK-1: Точность классификации рисков (Risk Precision)**
- **Формула:** `P_RISK = правильно_классифицированных / всех_классифицированных`
- **Целевое значение:** >= 75%
- **Критическое значение:** < 55%
- **Описание:** Доля корректных срабатываний детектора рисков

**RISK-2: Полнота детекции рисков (Risk Recall)**
- **Формула:** `R_RISK = найденных_рисков / всех_реальных_рисков`
- **Целевое значение:** >= 70%
- **Критическое значение:** < 50%
- **Описание:** Доля обнаруженных статей с рисками

**RISK-3: F1-мера для рисков (Risk F1-Score)**
- **Формула:** `F1_RISK = 2 * (P_RISK * R_RISK) / (P_RISK + R_RISK)`
- **Целевое значение:** >= 72%
- **Критическое значение:** < 52%

### 6.2. Покрытие типов рисков

**RISK-4: Покрытие категорий рисков (Risk Category Coverage)**
- **Категории:** коррупция, мошенничество, санкции, судебные процессы, банкротство, криминал, конфликт интересов, нарушения
- **Формула:** `RCC = обнаруженных_категорий / всех_целевых_категорий`
- **Целевое значение:** >= 75% (6 из 8 категорий)
- **Критическое значение:** < 50% (менее 4 категорий)

**RISK-5: Распределение уровней риска (Risk Level Distribution)**
- **Уровни:** CRITICAL, HIGH, MEDIUM, LOW
- **Целевое значение:** Логичное распределение (больше LOW/MEDIUM)
- **Описание:** Адекватность оценки серьезности рисков

**RISK-6: Средний скор риска (Average Risk Score)**
- **Формула:** `ARS = среднее(risk_score_всех_статей)`
- **Целевое значение:** 0.15-0.35 (зависит от источников)
- **Описание:** Общий уровень "токсичности" новостной ленты

## 7. Метрики производительности (Performance Metrics)

### 7.1. Скорость обработки

**PERF-1: Время обработки одной статьи (Processing Time per Article)**
- **Формула:** `PTA = общее_время_обработки / количество_статей`
- **Целевое значение:** <= 10 сек/статья (по ТЗ)
- **Критическое значение:** > 20 сек/статья
- **Описание:** Среднее время полной обработки статьи

**PERF-2: Производительность API (API Throughput)**
- **Формула:** `AT = успешных_запросов / время_сек`
- **Целевое значение:** >= 5 запросов/сек
- **Критическое значение:** < 1 запрос/сек
- **Описание:** Пропускная способность REST API

**PERF-3: Время отклика API (API Response Time)**
- **Формула:** `ART = p95(время_ответа_на_запрос)`
- **Целевое значение:** <= 10 сек (по ТЗ)
- **Критическое значение:** > 15 сек
- **Описание:** 95-й перцентиль времени ответа API

**PERF-4: Использование памяти (Memory Usage)**
- **Формула:** `MU = пиковая_память_MB`
- **Целевое значение:** <= 4 GB
- **Критическое значение:** > 8 GB
- **Описание:** Максимальное потребление RAM

### 7.2. Надежность системы

**PERF-5: Доступность системы (System Uptime)**
- **Формула:** `SU = (время_работы / общее_время) * 100%`
- **Целевое значение:** >= 99%
- **Критическое значение:** < 95%
- **Описание:** Процент времени работоспособности системы

**PERF-6: Частота ошибок (Error Rate)**
- **Формула:** `ER = (запросов_с_ошибками / всех_запросов) * 100%`
- **Целевое значение:** <= 5%
- **Критическое значение:** > 15%
- **Описание:** Доля неуспешных операций

## 8. Бизнес-метрики (Business Metrics)

### 8.1. Эффективность для конечного пользователя

**BIZ-1: Сокращение времени проверки (Time Reduction)**
- **Формула:** `TR = (время_ручной_проверки - время_с_системой) / время_ручной_проверки * 100%`
- **Целевое значение:** >= 90% (3-5 часов -> 15-20 минут по ТЗ)
- **Критическое значение:** < 60%
- **Описание:** Процент сэкономленного времени compliance-офицера

**BIZ-2: Полнота досье (Dossier Completeness)**
- **Формула:** `DC = полей_заполненных / полей_требуемых * 100%`
- **Целевые поля:** ФИО, должность, компания, события, риски, связи
- **Целевое значение:** >= 70%
- **Описание:** Процент автоматически заполненных полей досье

**BIZ-3: Обнаружение скрытых связей (Hidden Links Discovery)**
- **Формула:** `HLD = новых_связей_обнаружено / общего_количества_связей * 100%`
- **Целевое значение:** >= 20%
- **Описание:** Доля связей, которые не очевидны при ручной проверке

## 9. Метрики качества данных (Data Quality Metrics)

**DQ-1: Полнота метаданных (Metadata Completeness)**
- **Формула:** `MDC = статей_с_полными_метаданными / всех_статей * 100%`
- **Обязательные поля:** title, link, pub_date, content, source
- **Целевое значение:** >= 95%

**DQ-2: Валидность дат (Date Validity)**
- **Формула:** `DV = статей_с_корректными_датами / всех_статей * 100%`
- **Целевое значение:** >= 98%
- **Описание:** Процент корректно распознанных и валидных дат

**DQ-3: Дублирование контента (Content Duplication)**
- **Формула:** `CD = уникальных_статей / всех_статей * 100%`
- **Целевое значение:** >= 95%
- **Описание:** Процент уникального контента в базе

## 10. Интегральные метрики (Aggregate Metrics)

### 10.1. Общее качество системы

**AGG-1: Общий индекс качества (Overall Quality Index)**
- **Формула:** 
  ```
  OQI = 0.3 * F1_macro_NER + 
        0.25 * F1_REL + 
        0.25 * F1_RISK + 
        0.1 * PSR + 
        0.1 * (1 - ER)
  ```
- **Целевое значение:** >= 0.65
- **Критическое значение:** < 0.45
- **Описание:** Взвешенная оценка всех ключевых компонентов

**AGG-2: Индекс зрелости системы (System Maturity Index)**
- **Компоненты:** Покрытие функций, стабильность, документация, автоматизация
- **Шкала:** 1-5 (1=MVP, 5=Production-ready)
- **Целевое значение:** >= 3 (рабочий прототип по ТЗ)

## 11. Методология сбора метрик

### 11.1. Тестовый датасет

Для корректной оценки метрик NER, REL и RISK необходимо:

1. **Ручная разметка эталонного датасета:**
   - Объем: 50-100 статей
   - Разметчики: 2-3 человека со знанием азербайджанского
   - Процесс: двойная независимая разметка + разрешение конфликтов
   - Разметка: сущности (PER, ORG, LOC, POS), связи, риски

2. **Генерация синтетического датасета через LLM:**
   - Использование GPT-4/Claude для создания размеченных примеров
   - Валидация экспертом
   - Объем: 100-200 примеров

3. **Кросс-валидация:**
   - Split: 70% train / 15% validation / 15% test
   - Оценка на test set для финальных метрик

### 11.2. Инструменты для сбора метрик

```python
# Пример структуры метрик
class MetricsCollector:
    def __init__(self):
        self.metrics = {
            'ner': {},
            'relationships': {},
            'risks': {},
            'performance': {},
            'data_quality': {}
        }
    
    def calculate_ner_metrics(self, predictions, ground_truth):
        # Precision, Recall, F1 для каждого типа сущности
        pass
    
    def calculate_relationship_metrics(self, extracted_rels, true_rels):
        # Точность, полнота связей
        pass
    
    def measure_performance(self, start_time, end_time, articles_count):
        # Время обработки, throughput
        pass
    
    def generate_report(self):
        # JSON/HTML отчет с визуализациями
        pass
```

### 11.3. Частота измерения

| Тип метрики | Частота измерения |
|-------------|-------------------|
| NER качество | После обработки каждой партии (batch) |
| Производительность | Непрерывный мониторинг |
| Качество данных | 1 раз в день |
| Бизнес-метрики | 1 раз в неделю |
| Интегральные | 1 раз в неделю |

## 12. Dashboard и визуализация

### 12.1. Рекомендуемые графики

1. **NER Dashboard:**
   - Precision/Recall/F1 по типам сущностей (bar chart)
   - Confusion matrix для типов сущностей
   - Распределение confidence scores (histogram)

2. **Relationships Dashboard:**
   - Граф знаний с топ-связями
   - Heatmap типов связей
   - Временная динамика появления связей

3. **Risk Dashboard:**
   - Pie chart распределения уровней риска
   - Timeline рисковых событий
   - Top-10 самых рисковых сущностей

4. **Performance Dashboard:**
   - Line chart времени обработки (time series)
   - API response time percentiles (violin plot)
   - Memory usage over time

### 12.2. Инструменты визуализации

- **Streamlit**: интерактивный dashboard
- **Grafana**: real-time мониторинг производительности
- **Plotly/Matplotlib**: статические отчеты
- **NetworkX + Pyvis**: визуализация графа знаний

## 13. Пороги алертинга

### 13.1. Критические алерты (CRITICAL)

| Метрика | Условие | Действие |
|---------|---------|----------|
| PSR (Parse Success Rate) | < 60% | Остановить парсинг, проверить источники |
| F1_macro (NER) | < 40% | Переобучить модель / проверить данные |
| API Response Time | > 15 сек | Масштабировать инфраструктуру |
| Error Rate | > 15% | Откатить последний deploy |

### 13.2. Предупреждающие алерты (WARNING)

| Метрика | Условие | Действие |
|---------|---------|----------|
| F1_PER | < 50% | Проверить качество NER модели |
| Relationship Precision | < 60% | Пересмотреть паттерны связей |
| Data Freshness | > 60 дней | Запустить повторный парсинг |

## 14. Roadmap улучшения метрик

### Фаза 1: MVP (текущая)
- [x] Базовые метрики NER (Precision, Recall, F1)
- [x] Производительность API
- [x] Объем базы данных

### Фаза 2: Production-ready
- [ ] Полный набор метрик связей
- [ ] Детальный мониторинг рисков
- [ ] A/B тестирование моделей

### Фаза 3: Advanced Analytics
- [ ] Предсказание трендов рисков
- [ ] Аномалии в графе знаний
- [ ] Репутационный scoring

## 15. Заключение

Данная система метрик обеспечивает:

1. **Комплексную оценку** всех компонентов пайплайна
2. **Прозрачность** для стейкхолдеров (соответствие ТЗ >=28 баллов)
3. **Управляемость** через четкие пороги и алерты
4. **Измеримый прогресс** на пути к production-ready системе

**Ключевые метрики для защиты проекта:**
- Точность извлечения имен: **>=60%** (NER-1)
- Покрытие источников: **1-2 сайта** (DCM-1)
- Объем базы: **>=200 статей** (DCM-3)
- API response time: **<=10 сек** (PERF-3)

**Контакты для вопросов:**  
Для вопросов и предложений обращайтесь через GitHub Issues
