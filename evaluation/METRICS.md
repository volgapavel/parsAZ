## Как считаются метрики (кратко)

### Входные данные
- **Gold**: JSON со статьями и ручной разметкой `gold_entities`, учитываются только записи с `manually_verified=true`.
- **Predictions**: JSON со статьями и предсказанными `entities`, индексируется по `article_id`.

Запуск:
- `python evaluation/metrics_evaluator.py --gold <path> --pred <path> --out <path>`

### Какие сущности считаем
Сейчас считаются только 3 типа:
- `persons`
- `organizations`
- `locations`

(`positions/dates` в gold могут быть, но в метрики пока не включены.)

### Нормализация строк (перед сравнением)
Каждое имя сущности приводится к каноническому виду:
- lower-case
- удаление пунктуации
- схлопывание пробелов

### Сопоставление pred vs gold (fuzzy matching)
Для каждой статьи и каждого типа сущностей сравниваются **множества уникальных имён**.
Предсказание считается совпавшим (TP), если выполняется одно из условий:
- **точное совпадение** нормализованных строк
- **включение** (одна строка является подстрокой другой)
- **совпадение по фамилии** (последнее слово совпадает и длина ≥ 4)

Далее считаем:
- **TP**: предсказания, сопоставленные с gold
- **FP**: предсказания, не сопоставленные с gold
- **FN**: gold, не сопоставленные с предсказаниями

Счётчики суммируются по всем статьям (**micro-агрегация**).

### Precision / Recall / F1
Для каждого типа и для `overall`:
- \(precision = TP / (TP + FP)\)
- \(recall = TP / (TP + FN)\)
- \(F1 = 2PR/(P+R)\)

`support = TP + FN` — количество gold-сущностей (после нормализации).

### Coverage-метрики (насколько часто пайплайн вообще извлекает)
Считаются на пересечении статей, которые есть и в gold, и в predictions:
- **Articles with ANY prediction**: доля статей, где суммарно по `persons+organizations+locations` найдено > 0 сущностей
- **pct_articles_with_pred** (по типу): доля статей, где по данному типу найдено > 0 сущностей
- **avg_pred_per_article / avg_gold_per_article**: среднее число (уникальных) сущностей на статью
- **missing_in_predictions**: сколько gold-статей не найдено в predictions по `article_id`


